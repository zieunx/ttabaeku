# 2-2. ë„ì»¤ ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜ / PCì— ì§ì ‘ ì„¤ì¹˜í•˜ê¸°

> CNI (Container Network Interface)
> 

ì»¨ã…”ì´ë„ˆì™€ ì»¨í…Œì´ë„ˆê°€ í†µì‹ í•  ìˆ˜ ìˆëŠ” ì¼ì¢…ì˜ ì†Œí”„íŠ¸ì›¨ì–´.

ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ì“°ë ¤ë©´ ë°˜ë“œì‹  CNIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤. 

í”Œë¼ë„¬, ì¹¼ë¦¬ì½”, ìœ„ë¸Œë„·..

# EC2ì— k8s í™˜ê²½ ì„¤ì¹˜í•˜ê¸°

### docker ì„¤ì¹˜

> [https://docs.docker.com/engine/install/ubuntu/](https://docs.docker.com/engine/install/ubuntu/)
> 

ì„¤ì¹˜í•˜ë ¤ëŠ” ì‹œê¸°ì™€ ë²„ì „ì— ë”°ë¼ ëª…ë ¹ì–´ëŠ” ìƒì´í•  ìˆ˜ ìˆë‹¤.

ê·¸ë˜ì„œ ê³µí™ˆì˜ ëª…ë ¹ì–´ë¥¼ ê·¸ë•Œ ê·¸ë•Œ ì°¸ê³ í•´ì„œ ì¨ì•¼í•¨.

ì•„ë˜ëŠ” ë‚´ê°€ ì‹¤ìŠµí•˜ë©´ì„œ ì°¸ê³ í•œ ê³µí™ˆì˜ ëª…ë ¹ì–´ì´ë‹¤.

```bash
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install -y ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

ì„œë²„ ì‹¤í–‰í•  ë•Œë§ˆë‹¤ docker ìë™ìœ¼ë¡œ ì‹¤í–‰ì‹œí‚¤ê¸°

```bash
sudo systemctl enable docker
sudo systemctl start docker
sudo docker version

```

### 1. k8s ì„¤ì¹˜

> documentation > Installing Kubernetes with deployment tools
> 

ê³µí™ˆë§í¬: [https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-01-29 á„‹á…©á„’á…® 11.03.31.png](images/2-2/1.png)

<aside>
ğŸ’¡ Swap configuration. The default behavior of a kubelet was to fail to start if swap memory was detected on a node. Swap has been supported since v1.22. And since v1.28, Swap is supported for cgroup v2 only; the NodeSwap feature gate of the kubelet is beta but disabled by default. YouÂ **MUST**Â disable swap if the kubelet is not properly configured to use swap. For example,Â `sudo swapoff -a`Â will disable swapping temporarily. To make this change persistent across reboots, make sure swap is disabled in config files likeÂ `/etc/fstab`,Â `systemd.swap`, depending how it was configured on your system.

</aside>

**swap disable**

```bash
sudo swapoff -a && sudo sed -i '/swap/s/^/#/' /etc/fstab
```

**ë°©í™”ë²½ í•´ì œ**

```bash
sudo systemctl stop firewalld
sudo systemctl disable firewalld
```

<aside>
âš ï¸ ì´ ë¶€ë¶„ firewalld ê°€ ì—†ì–´ì„œ ì‹¤í–‰ë˜ì§€ ì•Šê³  ìˆìŒ.
ë°©í™”ë²½ê³¼ ê´€ë ¨ëœ ë¬¸ì œê°€ ìƒê¸°ë©´ ë‹¤ì‹œ í™•ì¸í•´ë´ì•¼í•¨.

</aside>

### 2. **kubeadm, kubelet, kubectl ì„¤ì¹˜**

```bash
sudo apt-get update
# apt-transport-https may be a dummy package; if so, you can skip that package
sudo apt-get install -y apt-transport-https ca-certificates curl gpg

# If the folder `/etc/apt/keyrings` does not exist, it should be created before the curl command, read the note below.
# sudo mkdir -p -m 755 /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

# This overwrites any existing configuration in /etc/apt/sources.list.d/kubernetes.list
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```

```bash
sudo systemctl start kubelet
sudo systemctl enable kubelet
```

### í´ëŸ¬ìŠ¤í„° ë§Œë“¤ê¸° with kubeadm

[https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/)

control-plan node ëŠ” master nodeì—ë§Œ ë§Œë“¤ì–´ì•¼ í•œë‹¤.

```bash
sudo kubeadm init --v=5
```

â†’ ì´ê±°ì‹¤íŒ¨í•˜ê³ ìˆìŒâ€¦

- error message: validate service connection: validate CRI v1 runtime API for endpoint \"unix:///var/run/containerd/containerd.sock\
    
    <aside>
    âš ï¸ [preflight] Running pre-flight checks
    error execution phase preflight: [preflight] Some fatal errors occurred:
    	[ERROR CRI]: container runtime is not running: output: time="2024-02-04T10:46:58Z" level=fatal msg="validate service connection: validate CRI v1 runtime API for endpoint \"unix:///var/run/containerd/containerd.sock\": rpc error: code = Unimplemented desc = unknown service runtime.v1.RuntimeService"
    , error: exit status 1
    
    </aside>
    
    1. config.toml ì‚­ì œ
    
    ```bash
    rm /etc/containerd/config.toml
    ```
    
    1. containerd ì¬ì‹œì‘
    
    ```bash
    systemctl restart containerd
    ```
    
    1. control-plan node ë§Œë“¤ê¸° ì¬ì‹œë„
    
    ```bash
    kubeadm init
    ```
    

- error execution phase addon/kube-proxy: error when creating kube-proxy service account: unable to create serviceaccount: rpc error: code = Unknown desc = malformed header: missing HTTP content-type
    
    <aside>
    âš ï¸ error execution phase addon/kube-proxy: error when creating kube-proxy service account: unable to create serviceaccount: rpc error: code = Unknown desc = malformed header: missing HTTP content-type
    To see the stack trace of this error execute with --v=5 or higher
    
    </aside>
    
    ìœ„ì—êº¼ í•´ê²°í•˜ë‹ˆ ë˜ ì´ëŸ°ë¬¸ì œ ìƒê¹€..
    
    ë‹¤ì‹œ `sudo kubeadm init` í•´ì¤„ë¬ë”ë‹ˆ ì´ë¯¸ ì„¤ì¹˜ê°€ ì§„í–‰ì¤‘ì— ì‹¤íŒ¨í–ˆë˜ê±°ë¼ ë¦¬ì…‹ì„ í•´ì¤˜ì•¼í–ˆë‹¤.
    
    1. kubeadm reset
    
    ```bash
    sudo kubeadm init --v=5
    ```
    
    ë¦¬ì…‹ë„ í•˜ë‹¤ê°€ ë­” ì—ëŸ¬ ë‚˜ì„œ â€”v=5 ë¶™í˜€ì¤Œâ€¦
    
    1. sudo kubeadm init
    
    ```bash
    sudo kubeadm init --v=5
    ```
    
    ë²„ì „ë¶™í˜€ì¤˜ì•¼ë˜ëŠ”ê±°ê°™ì•„ì„œ í•´ì¤¬ë”ë‹ˆ ì˜ë¨;;;
    

ì„±ê³µí•˜ë©´ ì´ëŸ° ë©”ì‹œì§€ê°€ ì­‰ ì¶œë ¥ëœë‹¤.

<aside>
ğŸ’¡ Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
[https://kubernetes.io/docs/concepts/cluster-administration/addons/](https://kubernetes.io/docs/concepts/cluster-administration/addons/)

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 172.31.38.52:6443 --token 31nm47.vsuzgagfldwbf5nv \
--discovery-token-ca-cert-hash sha256:8bb077e5b8be2c7a95ace8373c4943c241aa3c42ac148320d9405d611d2bb1a5

</aside>

ì­‰ ì„¤ëª…ê³¼ í•¨ê»˜ í† í°ì´ ìˆìŒ.

ì¼ë‹¨ í† í°ë¶€í„° ì €ì¥í•˜ì.

<aside>
âš ï¸ í† í°~

kubeadm join 172.31.38.52:6443 --token 31nm47.vsuzgagfldwbf5nv \
--discovery-token-ca-cert-hash sha256:8bb077e5b8be2c7a95ace8373c4943c241aa3c42ac148320d9405d611d2bb1a5

</aside>

ì›Œì»¤ë…¸ë“œë“¤ì´ ì´ê±°ë¡œ ì¡°ì¸í•  ìˆ˜ ìˆë„ë¡ ì‚¬ìš©í•  ê²ƒì´ë‹¤. ì´ê±¸ ë³´ê´€í•´ë†”ì•¼ëœë‹¤.

```bash
cat > token.txt
```

cat > token.txt

To Start~ ë¶€ë¶„ì„ ë³´ë©´ì‚¬ìš©ìë“¤ì´ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë­ ì‹¤í–‰í•´ì¤˜ì•¼ëœë‹¤.

ì‹¤í–‰í•´ì£¼ê³  ë…¸ë“œí™•ì¸

ì£¼ì˜í• ì ì€ sudoëŠ” ë¹¼ê³  í•´ì•¼í•¨. ì´ìœ ëŠ” ì°¾ì•„ë³´ë„ë¡í•˜ì.

```bash
kubectl get nodes
```

### 3. **Installing a Pod network add-on**

ì–´ì©Œê³  ë³µì¡í•˜ë‹ˆ ê°•ì‚¬ë‹˜ ê¹ƒí—™ì˜ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ë¼ê³  í•˜ì‹ ë‹¤.

[https://github.com/237summit/k8s_core_labs?tab=readme-ov-file#installing-a-pod-network-add-on](https://github.com/237summit/k8s_core_labs?tab=readme-ov-file#installing-a-pod-network-add-on)

---

ìœ¼ìœ¼â€¦ê°œë¹¡ì¹œë‹¤ ì„¤ì •í•˜ë‹¤ê°€ ë­ì•ˆë˜ê³  ì•ˆë˜ê³ â€¦

ë‹¤í–‰íˆ ì„ ìƒë‹˜ì´ EC2 ë…¸ì…˜ì„¤ëª…ë§í¬ë‹¬ì•„ë†“ì€ê±° ë°œê²¬í•¨ ã„·ã„·

[**Set up a K8S(v1.25) cluster on AWS EC2( Ubuntu 22.04)**](https://www.notion.so/Set-up-a-K8S-v1-25-cluster-on-AWS-EC2-Ubuntu-22-04-c3c059755dad4c6882cacb7337c2c812?pvs=21)